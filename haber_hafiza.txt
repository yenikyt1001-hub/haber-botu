import feedparser
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import time
import os
import random

# --- AYARLAR ---
GMAIL_ADRES = "yenikyt1001@gmail.com"
GMAIL_SIFRE = os.environ.get('GMAIL_SIFRE')
BLOGGER_MAIL = "yenikyt1001.sesli@blogger.com" # BurayÄ± kontrol et kral!
YOUTUBE_LINK = "https://www.youtube.com/@KANAL_ADIN"

KAYNAKLAR = ["https://www.ntv.com.tr/gundem.rss", "https://rss.haberler.com/rss.asp"]
LOG_DOSYASI = "haber_hafiza.txt"

def metni_ai_ozetle(metin):
    cumleler = metin.split('.')
    return f"{cumleler[0]}. {random.choice(cumleler[1:-1])}." if len(cumleler) > 2 else metin

def blogda_yayinla(baslik, icerik, link=""):
    msg = MIMEMultipart()
    msg['From'] = GMAIL_ADRES
    msg['To'] = BLOGGER_MAIL
    msg['Subject'] = f"{baslik} (Son Dakika) #Haber"
    
    yeni_icerik = metni_ai_ozetle(icerik)
    html_icerik = f"<div style='font-family:sans-serif;'><h2>ğŸ™ï¸ {baslik}</h2><p>{yeni_icerik}</p><br><a href='{YOUTUBE_LINK}'>ğŸ”´ YOUTUBE'DA SESLÄ° DÄ°NLE</a></div>"
    msg.attach(MIMEText(html_icerik, 'html'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587); server.starttls(); server.login(GMAIL_ADRES, GMAIL_SIFRE)
        server.sendmail(GMAIL_ADRES, BLOGGER_MAIL, msg.as_string()); server.quit()
        return True
    except: return False

if not os.path.exists(LOG_DOSYASI): open(LOG_DOSYASI, "w").close()

paylasilan = 0
for url in KAYNAKLAR:
    if paylasilan >= 2: break # Saatte maks 2 haber
    feed = feedparser.parse(url)
    for entry in feed.entries[:5]:
        if paylasilan >= 2: break
        if entry.link not in open(LOG_DOSYASI).read():
            if blogda_yayinla(entry.title, entry.get('summary', ''), entry.link):
                with open(LOG_DOSYASI, "a") as f: f.write(entry.link + "\n")
                paylasilan += 1
                time.sleep(10) # KÄ±sa bekleme